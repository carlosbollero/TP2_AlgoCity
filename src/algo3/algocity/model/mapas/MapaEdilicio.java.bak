package algo3.algocity.model.mapas;

import java.awt.Point;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.Map;
import java.util.Observable;
import java.util.Map.Entry;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import algo3.algocity.model.caracteristicas.Daniable;
import algo3.algocity.model.caracteristicas.Ocupable;
import algo3.algocity.model.conexiones.LineaTension;
import algo3.algocity.model.conexiones.Ruta;
import algo3.algocity.model.construcciones.CentralEolica;
import algo3.algocity.model.construcciones.CentralMinera;
import algo3.algocity.model.construcciones.CentralNuclear;
import algo3.algocity.model.construcciones.EstacionDeBomberos;
import algo3.algocity.model.construcciones.PozoDeAgua;
import algo3.algocity.model.construcciones.Unidad;
import algo3.algocity.model.construcciones.UnidadComercial;
import algo3.algocity.model.construcciones.UnidadEnergetica;
import algo3.algocity.model.construcciones.UnidadIndustrial;
import algo3.algocity.model.construcciones.UnidadResidencial;

public class MapaEdilicio extends Observable {

	Mapa mapaSuperior;
	HashMap<Coordenada, Unidad> mapa;

	ArrayList<Daniable> unidadesDaniables;

	// prueba
	ArrayList<UnidadEnergetica> unidadesEnergeticas;
	ArrayList<PozoDeAgua> pozosDeAgua;
	ArrayList<EstacionDeBomberos> estacionesBomberos;
	ArrayList<UnidadResidencial> unidadesResidenciales;
	ArrayList<UnidadIndustrial> unidadesIndustriales;
	ArrayList<UnidadComercial> unidadesComerciales;

	public MapaEdilicio(Mapa m) {
		mapa = new HashMap<Coordenada, Unidad>();
		unidadesDaniables = new ArrayList<Daniable>();
		unidadesResidenciales = new ArrayList<UnidadResidencial>();
		unidadesIndustriales = new ArrayList<UnidadIndustrial>();
		unidadesComerciales = new ArrayList<UnidadComercial>();
		estacionesBomberos = new ArrayList<EstacionDeBomberos>();
		pozosDeAgua = new ArrayList<PozoDeAgua>();
		unidadesEnergeticas = new ArrayList<UnidadEnergetica>();
	}

	/* Para tests */
	public MapaEdilicio() {
		mapa = new HashMap<Coordenada, Unidad>();

		unidadesDaniables = new ArrayList<Daniable>();
	}

//	public boolean agregar(Unidad elemento) {
//		int x = elemento.coordenada().getX();
//		int y = elemento.coordenada().getY();
//		if (!.validarCoordenadas(x, y) || this.contiene(elemento)) {
//			return false;
//		}
//		if (!this.mapa.containsKey(elemento.coordenada())) {
//			this.mapa.put(elemento.coordenada(), elemento);
//			return true;
//		}
//		return false;
//	}

	public boolean agregar(PozoDeAgua p) {
		mapa.put(p.coordenada(), p);
		setChanged();
		notifyObservers(p.coordenada());
		return pozosDeAgua.add(p);
	}

	public boolean agregar(EstacionDeBomberos e) {
		mapa.put(e.coordenada(), e);
		setChanged();
		notifyObservers(e.coordenada());
		return estacionesBomberos.add(e);
	}

	public boolean agregar(UnidadResidencial u) {
		mapa.put(u.coordenada(), u);
		setChanged();
		notifyObservers(u.coordenada());
		return unidadesResidenciales.add(u);
	}

	public boolean agregar(UnidadIndustrial u) {
		mapa.put(u.coordenada(), u);
		setChanged();
		notifyObservers(u.coordenada());
		return unidadesIndustriales.add(u);
	}

	public boolean agregar(UnidadComercial u) {
		mapa.put(u.coordenada(), u);
		setChanged();
		notifyObservers(u.coordenada());
		return unidadesComerciales.add(u);
	}

	public boolean agregar(UnidadEnergetica u) {
		mapa.put(u.coordenada(), u);
		setChanged();
		notifyObservers(u.coordenada());
		return unidadesEnergeticas.add(u);
	}

//	public boolean agregarUnidadDaniable(Daniable unidad) {
//		if (unidadesDaniables == null) {
//			unidadesDaniables = new ArrayList<Daniable>();
//		}
//		return unidadesDaniables.add(unidad);
//	}

	public ArrayList<UnidadEnergetica> getUnidadesEnergeticas() {
		return unidadesEnergeticas;
	}

	public ArrayList<PozoDeAgua> getPozosDeAgua() {
		return pozosDeAgua;
	}
	
	public ArrayList<EstacionDeBomberos> getestacionesDeBomberos() {
		return estacionesBomberos;
	}

	public ArrayList<Daniable> unidadesDaniables() {
//		return unidadesDaniables;
		ArrayList<Daniable> lista = new ArrayList<Daniable>(unidadesResidenciales);
		lista.addAll(unidadesIndustriales);
		lista.addAll(unidadesComerciales);
		lista.addAll(unidadesEnergeticas);
		return lista;
	}

	public void remover(int x, int y) {
		this.mapa.remove(new Coordenada(x, y));
		setChanged();
		notifyObservers();
	}

	public boolean contiene(Unidad unaUnidad) {
		return (this.mapa.containsValue(unaUnidad));
	}

	public boolean tieneCoordenadaOcupada(Coordenada coord) {
		return (this.mapa.containsKey(coord));
	}

	public boolean vacia() {
		return (this.mapa.isEmpty());
	}

	public Coordenada getCoordenadas(Unidad elemento) {
		for (Entry<Coordenada, Unidad> entry : mapa.entrySet()) {
			if (entry.getValue().equals(elemento)) {
				return entry.getKey();
			}
		}
		return null;
	}

	public Unidad getUnidadEn(Coordenada coord) {
		if (tieneCoordenadaOcupada(coord)) {
			return (this.mapa.get(coord));
		} else {
			return null;
		}
	}

//	public ArrayList<Daniable> getUnidadesAlrededorDe(Coordenada epicentro,
//			int radio) {
//		ArrayList<Daniable> unidadesADevolver = new ArrayList<Daniable>();
//		Coordenada inic = calcularCoordenadaDeInicio(epicentro, radio);
//		Coordenada fin = calcularCoordenadaDeFin(epicentro, radio);
//
//		for (int x = (int) inic.getX(); x < (int) fin.getX(); x++) {
//			for (int y = (int) inic.getY(); y < (int) fin.getY(); y++) {
//				if (validarCoordenadas(x, y) && existeDaniable(x, y)) {
//					unidadesADevolver.add((Daniable) this.getDaniableEn(x, y));
//				}
//			}
//		}
//		return unidadesADevolver;
//	}

	public ArrayList<Daniable> getDaniablesEnElCaminoDe(
			LinkedList<Coordenada> listaCamino) {
		ArrayList<Daniable> listaDaniablesEnElCamino = new ArrayList<Daniable>();
		Iterator<Coordenada> iterador = listaCamino.iterator();
		while (iterador.hasNext()) {
			Coordenada punto = iterador.next();
			if (existeDaniable((int) punto.getX(), (int) punto.getY())) {
				listaDaniablesEnElCamino.add(getDaniableEn((int) punto.getX(),
						(int) punto.getY()));
			}
		}
		return listaDaniablesEnElCamino;
	}

	private boolean existeDaniable(int x, int y) {
		Iterator<Daniable> it = unidadesDaniables.iterator();
		while (it.hasNext()) {
			Daniable d = it.next();
			if (d.coordenada().getX() == x && d.coordenada().getY() == y) {
				return true;
			}
		}
		return false;
	}

	private Daniable getDaniableEn(int x, int y) {
		Iterator<Daniable> it = unidadesDaniables.iterator();
		while (it.hasNext()) {
			Daniable d = it.next();
			if (d.coordenada().getX() == x && d.coordenada().getY() == y) {
				return d;
			}
		}
		return null;

	}

//	private Coordenada calcularCoordenadaDeInicio(Coordenada epicentro,
//			int radio) {
//		int xi;
//		int yi;
//		if (epicentro.getX() - radio < 0) {
//			xi = 0;
//		} else {
//			xi = (int) epicentro.getX() - radio;
//		}
//		if (epicentro.getY() - radio < 0) {
//			yi = 0;
//		} else {
//			yi = (int) epicentro.getY() - radio;
//		}
//		return new Coordenada(xi, yi);
//	}
//
//	private Coordenada calcularCoordenadaDeFin(Coordenada epicentro, int radio) {
//		int xf;
//		int yf;
//		if (epicentro.getX() - radio < 0) {
//			xf = radio;
//		} else {
//			xf = (int) epicentro.getX() + radio;
//		}
//		if (epicentro.getY() - radio < 0) {
//			yf = radio;
//		} else {
//			yf = (int) epicentro.getY() + radio;
//		}
//		return new Coordenada(xf, yf);
//	}

	public int capacidadDePoblacion() {
		int capacidad = 0;
		for (UnidadResidencial unidad : unidadesResidenciales) {
			capacidad += unidad.capacidad();
		}
		return capacidad;
	}

	public int capacidadDeEmpleo() {
		int capacidad = 0;
		for (UnidadIndustrial unidad : unidadesIndustriales) {
			capacidad += unidad.capacidad();
		}
		return capacidad;
	}
	
	public ArrayList<UnidadResidencial> unidadesResidenciales(){
		return this.unidadesResidenciales();
	}
	
	public ArrayList<UnidadIndustrial> unidadesIndustriales(){
		return this.unidadesIndustriales();
	}
	
	

	/**********************************************************************/
	/**************************** Persistencia ****************************/
	/**********************************************************************/
	@SuppressWarnings("rawtypes")
	public Element getElement(Document doc, Element ciudad) {
		Element alto = doc.createElement("alto");
		ciudad.appendChild(alto);
		alto.setTextContent(String.valueOf(this.alto));

		Element ancho = doc.createElement("ancho");
		ciudad.appendChild(ancho);
		ancho.setTextContent(String.valueOf(this.ancho));

		Element mapa = doc.createElement("mapa");
		ciudad.appendChild(mapa);

		/* Serializacion de unidades del mapa */
		for (Map.Entry e : this.mapa.entrySet()) {
			Coordenada clave = (Coordenada) e.getKey();
			Unidad valor = (Unidad) e.getValue();

			Element nodo = doc.createElement("Nodo");
			mapa.appendChild(nodo);

			Element point = doc.createElement("Coordenada");
			nodo.appendChild(point);
			point.setTextContent(String.valueOf((int) clave.getX()) + ","
					+ String.valueOf((int) clave.getY()));

			Element unidad = valor.getElement(doc);
			nodo.appendChild(unidad);
		}

		/* Serializacion de unidades con poblacion */
		Element unidadesConPoblacion = doc
				.createElement("unidadesConPoblacion");
		ciudad.appendChild(unidadesConPoblacion);
		Iterator<Ocupable> it = this.unidadesConPoblacion.iterator();
		while (it.hasNext()) {
			Ocupable o = it.next();
			Element unidad = o.getElement(doc);
			unidadesConPoblacion.appendChild(unidad);
		}

		/* Serializacion de unidades con empleo */
		Element unidadesConEmpleo = doc.createElement("unidadesConEmpleo");
		ciudad.appendChild(unidadesConEmpleo);
		Iterator<Ocupable> it2 = this.unidadesConEmpleo.iterator();
		while (it2.hasNext()) {
			Ocupable o = it2.next();
			Element unidad = o.getElement(doc);
			unidadesConEmpleo.appendChild(unidad);
		}

		/* Serializacion de unidades daniables */
		Element unidadesDaniables = doc.createElement("unidadesDaniables");
		ciudad.appendChild(unidadesDaniables);
		Iterator<Daniable> it3 = this.unidadesDaniables.iterator();
		while (it3.hasNext()) {
			Daniable o = it3.next();
			Element unidad = o.getElement(doc);
			unidadesDaniables.appendChild(unidad);
		}
		return ciudad;
	}

	public static MapaEdilicio fromElement(Node ciudad) {
		MapaEdilicio mapaEdilicio = new MapaEdilicio();
		NodeList hijosDeCiudad = ciudad.getChildNodes();

		for (int i = 0; i < hijosDeCiudad.getLength(); i++) {
			Node hijoDeCiudad = hijosDeCiudad.item(i);
			if (hijoDeCiudad.getNodeName().equals("alto")) {
				mapaEdilicio.alto = Integer.valueOf(hijoDeCiudad
						.getTextContent());
			} else if (hijoDeCiudad.getNodeName().equals("ancho")) {
				mapaEdilicio.ancho = Integer.valueOf(hijoDeCiudad
						.getTextContent());
			} else if (hijoDeCiudad.getNodeName().equals("mapa")) {
				NodeList hijosDeMapa = hijoDeCiudad.getChildNodes();
				for (int j = 0; j < hijosDeMapa.getLength(); j++) {
					Node hijoDeMapa = hijosDeMapa.item(j);
					if (hijoDeMapa.getNodeName().equals("Nodo")) {
						NodeList hijosDeNodo = hijoDeMapa.getChildNodes();
						String stringPunto = "";
						Coordenada puntoAAgregar = new Coordenada();
						for (int k = 0; k < hijosDeNodo.getLength(); k++) {
							Node hijoDeNodo = hijosDeNodo.item(k);
							if (hijoDeNodo.getNodeName().equals("Coordenada")) {
								stringPunto = hijoDeNodo.getTextContent();
								String[] arrayPunto = stringPunto.split(",");
								puntoAAgregar = new Coordenada(
										Integer.valueOf(arrayPunto[0]),
										Integer.valueOf(arrayPunto[1]));
							} else if (hijoDeNodo.getNodeName().equals(
									"UnidadComercial")) {
								UnidadComercial uc = new UnidadComercial();
								uc.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, uc);
							} else if (hijoDeNodo.getNodeName().equals(
									"UnidadIndustrial")) {
								UnidadIndustrial ui = new UnidadIndustrial();
								ui.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, ui);
							} else if (hijoDeNodo.getNodeName().equals(
									"EstacionDeBomberos")) {
								EstacionDeBomberos eb = new EstacionDeBomberos();
								eb.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, eb);
							} else if (hijoDeNodo.getNodeName().equals(
									"CentralNuclear")) {
								CentralNuclear cn = new CentralNuclear();
								cn.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, cn);
							} else if (hijoDeNodo.getNodeName().equals(
									"UnidadResidencial")) {
								UnidadResidencial ur = new UnidadResidencial();
								ur.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, ur);
							} else if (hijoDeNodo.getNodeName().equals(
									"PozoDeAgua")) {
								PozoDeAgua pa = new PozoDeAgua();
								pa.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, pa);
							} else if (hijoDeNodo.getNodeName().equals(
									"CentralMinera")) {
								CentralMinera cm = new CentralMinera();
								cm.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, cm);
							} else if (hijoDeNodo.getNodeName().equals(
									"CentralEolica")) {
								UnidadEnergetica ce = new CentralEolica();
								ce.fromElement(hijoDeNodo);
								mapaEdilicio.mapa.put(puntoAAgregar, ce);
							}
						}
					}
				}
			} else if (hijoDeCiudad.getNodeName()
					.equals("unidadesConPoblacion")) {
				NodeList hijosDeUnidadesConPoblacion = hijoDeCiudad
						.getChildNodes();
				for (int j = 0; j < hijosDeUnidadesConPoblacion.getLength(); j++) {
					Node hijoDeUnidadConPoblacion = hijosDeUnidadesConPoblacion
							.item(j);
					if (hijoDeUnidadConPoblacion.getNodeName().equals(
							"UnidadResidencial")) {
						UnidadResidencial ur = new UnidadResidencial();
						ur.fromElement(hijoDeUnidadConPoblacion);
						mapaEdilicio.unidadesConPoblacion.add(ur);
					}
				}
			} else if (hijoDeCiudad.getNodeName().equals("unidadesConEmpleo")) {
				NodeList hijosDeUnidadesConEmpleo = hijoDeCiudad
						.getChildNodes();
				for (int j = 0; j < hijosDeUnidadesConEmpleo.getLength(); j++) {
					Node hijoDeUnidadConEmpleo = hijosDeUnidadesConEmpleo
							.item(j);
					if (hijoDeUnidadConEmpleo.getNodeName().equals(
							"UnidadIndustrial")) {
						UnidadIndustrial ui = new UnidadIndustrial();
						ui.fromElement(hijoDeUnidadConEmpleo);
						mapaEdilicio.unidadesConEmpleo.add(ui);
					}
				}
			} else if (hijoDeCiudad.getNodeName().equals("unidadesDaniables")) {
				NodeList hijosDeUnidadesDaniables = hijoDeCiudad
						.getChildNodes();
				for (int j = 0; j < hijosDeUnidadesDaniables.getLength(); j++) {
					Node hijoDeUnidadDaniable = hijosDeUnidadesDaniables
							.item(j);
					if (hijoDeUnidadDaniable.getNodeName().equals(
							"UnidadIndustrial")) {
						UnidadIndustrial ui = new UnidadIndustrial();
						ui.fromElement(hijoDeUnidadDaniable);

						mapaEdilicio.unidadesDaniables.add(ui);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"UnidadResidencial")) {
						UnidadResidencial ur = new UnidadResidencial();
						ur.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(ur);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"UnidadComercial")) {
						Daniable uc = new UnidadComercial();
						uc.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(uc);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"CentralEolica")) {
						UnidadEnergetica ce = new CentralEolica();
						ce.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(ce);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"CentralMinera")) {
						CentralMinera cm = new CentralMinera();
						cm.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(cm);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"CentralNuclear")) {
						CentralNuclear cn = new CentralNuclear();
						cn.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(cn);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"EstacionDeBomberos")) {
						EstacionDeBomberos eb = new EstacionDeBomberos();
						eb.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(eb);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"PozoDeAgua")) {
						PozoDeAgua pa = new PozoDeAgua();
						pa.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(pa);
					} else if (hijoDeUnidadDaniable.getNodeName()
							.equals("Ruta")) {
						Ruta rt = new Ruta();
						rt.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(rt);
					} else if (hijoDeUnidadDaniable.getNodeName().equals(
							"LineaTension")) {
						LineaTension lt = new LineaTension();
						lt.fromElement(hijoDeUnidadDaniable);
						mapaEdilicio.unidadesDaniables.add(lt);
					}
				}
			}

		}
		// imprimirMapaEdilicio(mapaEdilicio);
		return mapaEdilicio;
	}

}